<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta property="og:title" content="AreaMap｜アクセスマップ">
  <meta property="og:description" content="初めての人でも迷わないアクセス案内（駐車場・入口あり）">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://areamap.onrender.com/areamaplite">
  <meta property="og:image" content="https://areamap.onrender.com/static/img/headermap.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="AreaMap-Pro｜アクセスマップ">
  <meta name="twitter:description" content="初めての人でも迷わないアクセス案内（駐車場・入口あり）">
  <meta name="twitter:image" content="https://areamap.onrender.com/static/img/headermap.jpg">

  <title>AreaMap-Pro版</title>

  <link rel="stylesheet" href="/static/css/areamap.css">
  <link rel="stylesheet" href="/static/css/areamap-pro.css">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <script>
    (() => {
      const p = new URLSearchParams(location.search);
      const mode = p.get("mode") || "page"; // page | embed | ig
      document.documentElement.setAttribute("data-areamap-view", mode);
    })();
  </script>

  <style>
    /* Leafletコンテナのサイズ（あなたの既存レイアウトに合わせて調整OK） */
    #areamap-leaflet {
      width: 100%;
      height: 520px;  /* ここは好みで。スマホなら 480〜600 あたりが無難 */
      border-radius: 12px;
      overflow: hidden;
      background: #f3f3f3;
    }

    /* Leaflet divIcon 内のボタン（既存のhotspot見た目に寄せる） */
    .areamap-hotspot-btn {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 0;
      cursor: pointer;
      background: rgba(0,0,0,0.65);
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }
    /* 種別で色やアイコンを変えたいならここで */
    .areamap-hotspot-btn.is-parking::after {
      content: "P";
      color: #fff;
      font-weight: 700;
      display: inline-block;
      line-height: 44px;
      width: 44px;
      text-align: center;
    }
    .areamap-hotspot-btn.is-menu::after {
      content: "≡";
      color: #fff;
      font-weight: 700;
      display: inline-block;
      line-height: 44px;
      width: 44px;
      text-align: center;
    }

    /* Leafletが付ける余白を抑えたい場合 */
    .leaflet-container { background: transparent; }
  </style>
</head>

<body data-areamap-mode="default">

  <div id="map-wrapper">
    <div class="map-image-container">

      <!-- 画像ではなくLeaflet -->
      <div
        id="areamap-leaflet"
        data-track="map_image_click"
        aria-label="AreaMap"
      ></div>

    </div>

    <div class="areamap-cta">
      <a
        id="google-map-link"
        data-track="google_map_click"
        href="https://www.google.com/maps/place/%E3%83%91%E3%83%BC%E3%82%BD%E3%83%8A%E3%83%AB%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%EF%BC%86%E3%82%B3%E3%83%B3%E3%83%87%E3%82%A3%E3%82%B7%E3%83%A7%E3%83%8B%E3%83%B3%E3%82%B0%E3%82%B8%E3%83%A0+S%E3%83%BBBODY/@36.107092,136.224629,14z/data=!4m6!3m5!1s0x5ff8bf327aa10c13:0x92bcedb7ecd7e870!8m2!3d36.107092!4d136.2246294!16s%2Fg%2F11h3q6s_6s?hl=ja&entry=ttu&g_ep=EgoyMDI1MTIwOS4wIKXMDSoASAFQAw%3D%3D"
        target="_blank"
        rel="noopener"
        class="btn-route"
      >
        GoogleMapを見る
      </a>
    </div>
  </div>

  <footer class="areamap-footer"></footer>

  <!-- モーダル（そのまま利用） -->
  <div id="img-modal" class="img-modal" aria-hidden="true">
    <div class="img-modal__overlay" data-close></div>

    <div class="img-modal__content" role="dialog" aria-modal="true" aria-label="画像プレビュー">
      <button class="img-modal__close" type="button" data-close aria-label="閉じる">×</button>
      <img id="img-modal-target" src="" alt="">
    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ✅ 計測 -->
  <script src="../static/js/areamap_metrics.js"></script>

  <script>
    // ───────────────────────────────
    // 1) モーダルを “外から呼べる” 形にする
    // ───────────────────────────────
    (function () {
      const modal = document.getElementById("img-modal");
      const modalImg = document.getElementById("img-modal-target");

      function openModal(src, alt) {
        if (!src) return;
        modalImg.src = src;
        modalImg.alt = alt || "";
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
        modalImg.src = "";
        modalImg.alt = "";
        document.body.style.overflow = "";
      }

      modal.addEventListener("click", (e) => {
        if (e.target && e.target.matches("[data-close]")) closeModal();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("is-open")) closeModal();
      });

      // 外部から呼べるように公開
      window.AreaMapModal = { openModal, closeModal };
    })();
  </script>

  <script>
    // ───────────────────────────────
    // 2) 計測トラッカー初期化
    // ───────────────────────────────
    const tracker = window.AreamapMetrics.createTracker({
      endpoint: "/api/metrics/log"
    });

    tracker.trackPageView("areamap_page_view");
  </script>

  <script>
    // ───────────────────────────────
    // 3) Leaflet画像オーバーレイ（タイル無し）で地図化
    // ───────────────────────────────
    (function () {
      const params = new URLSearchParams(location.search);
      const debug = params.get("debug") === "1";

      // 使う画像（元の areamaplite-map.jpg をそのまま使う）
      const imageUrl = "/static/img/areamaplite-map.jpg";

      // ホットスポット定義（％で指定：xPct=横、yPct=縦）
      // ★ここをあなたの地図に合わせて調整（debug=1で座標拾える）
      const hotspots = [
        {
          key: "parking",
          xPct: 22.0,   // 例
          yPct: 62.0,   // 例
          className: "is-parking",
          track: "hotspot_parking_open",
          modalImg: "../static/img/parking.png",
          modalAlt: "AreaMap駐車場",
          ariaLabel: "駐車場を表示"
        },
        {
          key: "menu",
          xPct: 70.0,   // 例
          yPct: 55.0,   // 例
          className: "is-menu",
          track: "hotspot_menu_open",
          modalImg: "../static/img/menu.png",
          modalAlt: "AreaMapメニュー",
          ariaLabel: "メニューを表示"
        }
      ];

      // 画像を読み込んで自然サイズを取得 → bounds を正しく作る
      const img = new Image();
      img.onload = () => initMap(img.naturalWidth, img.naturalHeight);
      img.src = imageUrl;

      function initMap(imgWidth, imgHeight) {
        // CRS.Simple：座標が画像ピクセル基準になる
        const map = L.map("areamap-leaflet", {
          crs: L.CRS.Simple,
          minZoom: -2,
          maxZoom: 2,
          zoomControl: true,
          attributionControl: false
        });

        const bounds = [[0, 0], [imgHeight, imgWidth]];

        // タイル無し：画像だけ敷く
        L.imageOverlay(imageUrl, bounds).addTo(map);

        map.fitBounds(bounds);
        map.setMaxBounds(bounds);
        map.on("drag", () => map.panInsideBounds(bounds, { animate: false }));

        // ％ → [y, x]（Leafletは latlng という名前だけど、ここではピクセル座標）
        const pctToLatLng = (xPct, yPct) => {
          const x = imgWidth  * (xPct / 100);
          const y = imgHeight * (yPct / 100);
          return [y, x];
        };

        // ホットスポットを追加（divIcon でボタンを埋め込む）
        hotspots.forEach((h) => {
          const html = `
            <button
              type="button"
              class="areamap-hotspot-btn ${h.className}"
              data-track="${h.track}"
              data-modal-img="${h.modalImg}"
              data-modal-alt="${h.modalAlt}"
              aria-label="${h.ariaLabel}"
            ></button>
          `;

          const icon = L.divIcon({
            className: "",      // Leafletデフォの枠を消す
            html,
            iconSize: [44, 44], // ボタンサイズに合わせる
            iconAnchor: [22, 22] // 中心合わせ
          });

          L.marker(pctToLatLng(h.xPct, h.yPct), { icon }).addTo(map);
        });

        // Leaflet内に挿入されたボタンにモーダル動作を付与（イベント委譲）
        const mapEl = document.getElementById("areamap-leaflet");
        mapEl.addEventListener("click", (e) => {
          const btn = e.target && e.target.closest && e.target.closest(".areamap-hotspot-btn");
          if (!btn) return;

          const src = btn.getAttribute("data-modal-img");
          const alt = btn.getAttribute("data-modal-alt") || "";
          window.AreaMapModal.openModal(src, alt);
        });

        // 「地図面クリック」を計測したい場合（APIがある時だけ）
        map.on("click", () => {
          if (typeof tracker.track === "function") {
            tracker.track("map_image_click");
          } else if (typeof tracker.trackEvent === "function") {
            tracker.trackEvent("map_image_click");
          }
        });

        // data-track をまとめてバインド（LeafletのボタンがDOMに入ってから実行）
        tracker.bindAutoClicks();

        // debug=1：クリック位置の％をconsoleに出す（ピン配置が超楽）
        if (debug) {
          map.on("click", (e) => {
            const y = e.latlng.lat;
            const x = e.latlng.lng;
            const xPct = (x / imgWidth) * 100;
            const yPct = (y / imgHeight) * 100;
            console.log("clicked percent:", {
              xPct: +xPct.toFixed(2),
              yPct: +yPct.toFixed(2)
            });
          });
        }
      }
    })();
  </script>
</body>
</html>
